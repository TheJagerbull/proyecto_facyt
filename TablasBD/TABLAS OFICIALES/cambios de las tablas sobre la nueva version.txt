VERSION NUEVA

  CREATE TABLE IF NOT EXISTS `alm_historial_s` (
    `ID` bigint(20) NOT NULL AUTO_INCREMENT,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `nr_solicitud` varchar(10) NOT NULL,
    `fecha_ej` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
    `usuario_ej` varchar(9) NOT NULL,
    `status_ej` enum('carrito','en_proceso','aprobado','enviado', 'retirado', 'completado', 'cancelado', 'anulado', 'cerrado') NOT NULL,
    PRIMARY KEY (`ID`),
    UNIQUE KEY `historial` (`nr_solicitud`, `status_ej`)
  ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
<?php
  $this->db->query('use db2');
  $campos = array(
                  'ID'=>      array(
                                    'type'=>'bigint',
                                    'constraint'=>20,
                                    'auto_increment'=>TRUE),
                  'TIME'=>    array(
                                    'type'=>'timestamp',
                                    'default'=>'CURRENT_TIMESTAMP',
                                    ''),
                  );



?>
  CREATE TABLE IF NOT EXISTS `alm_solicitud` (
    `ID` bigint(20) NOT NULL AUTO_INCREMENT,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `nr_solicitud` varchar(9) NOT NULL,
    `status` enum('carrito','en_proceso','aprobado','enviado','completado', 'cancelado', 'anulado', 'cerrado') NOT NULL,
    `observacion` text,
    `fecha_gen` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
    `fecha_comp` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`nr_solicitud`),
    UNIQUE KEY `ID` (`ID`)
  ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
<?php




?>
  CREATE TABLE IF NOT EXISTS `alm_efectua` (
    `ID` bigint(20) NOT NULL AUTO_INCREMENT,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_usuario` varchar(9) NOT NULL,
    `nr_solicitud` varchar(9) NOT NULL,
    `id_historial_s` bigint(20) NOT NULL,
    PRIMARY KEY (`ID`),
    UNIQUE KEY `procesa` (`id_usuario`,`nr_solicitud`, `id_historial_s`),
    UNIQUE KEY `ID` (`ID`),
    KEY `nr_solicitud` (`nr_solicitud`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
<?php




?>
  CREATE TABLE IF NOT EXISTS `alm_art_en_solicitud` (
    `ID` bigint(20) NOT NULL AUTO_INCREMENT,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_articulo` bigint(20) NOT NULL,
    `id_usuario` varchar(9) DEFAULT NULL,
    `nr_solicitud` varchar(9) NOT NULL,
    `cant_solicitada` int(11) NOT NULL,
    `cant_aprobada` int(11) DEFAULT NULL,
    `cant_usados` int(11) DEFAULT '0',
    `cant_nuevos` int(11) DEFAULT '0',
    `estado_articulo` enum('activo', 'anulado') NOT NULL DEFAULT 'activo',
    `motivo` text CHARACTER SET utf8 DEFAULT NULL,
    UNIQUE KEY `ID` (`ID`),
    UNIQUE KEY `cont_art_solicitud` (`id_articulo`,`nr_solicitud`),
    KEY `nr_solicitud` (`nr_solicitud`)
  ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
<?php




?>

VERSION VIEJA
  CREATE TABLE IF NOT EXISTS `alm_historial_s` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `NRS` varchar(10) NOT NULL,
    `fecha_gen` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
    `fecha_ap` timestamp NULL DEFAULT NULL,
    `fecha_desp` timestamp NULL DEFAULT NULL,
    `fecha_comp` timestamp NULL DEFAULT NULL,
    `usuario_gen` varchar(9) NOT NULL,
    `usuario_ap` varchar(9) DEFAULT NULL
  ) ENGINE=InnoDB AUTO_INCREMENT=153 DEFAULT CHARSET=utf8;

  CREATE TABLE IF NOT EXISTS `alm_aprueba` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_usuario` varchar(9) NOT NULL,
    `nr_solicitud` varchar(9) NOT NULL
  ) ENGINE=InnoDB AUTO_INCREMENT=148 DEFAULT CHARSET=utf8;

  CREATE TABLE IF NOT EXISTS `alm_genera` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_usuario` varchar(9) NOT NULL,
    `nr_solicitud` varchar(9) NOT NULL
  ) ENGINE=InnoDB AUTO_INCREMENT=153 DEFAULT CHARSET=utf8;

  CREATE TABLE IF NOT EXISTS `alm_retira` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `nr_solicitud` varchar(9) NOT NULL,
    `cod_articulo` varchar(9) NOT NULL,
    `id_usuario` varchar(9) NOT NULL
  ) ENGINE=InnoDB AUTO_INCREMENT=423 DEFAULT CHARSET=utf8;

  CREATE TABLE IF NOT EXISTS `alm_contiene` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_articulo` bigint(20) NOT NULL,
    `NRS` varchar(9) NOT NULL,
    `nr_solicitud` varchar(9) NOT NULL,
    `cant_solicitada` int(11) NOT NULL,
    `cant_aprobada` int(11) DEFAULT NULL,
    `cant_usados` int(11) DEFAULT '0',
    `cant_nuevos` int(11) DEFAULT '0'
  ) ENGINE=InnoDB AUTO_INCREMENT=501 DEFAULT CHARSET=utf8;

  CREATE TABLE IF NOT EXISTS `alm_solicitud` (
    `ID` bigint(20) NOT NULL,
    `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `id_usuario` varchar(9) NOT NULL,
    `nr_solicitud` varchar(9) NOT NULL,
    `status` enum('carrito','en_proceso','aprobada','enviado','completado') NOT NULL,
    `observacion` text,
    `fecha_gen` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
    `fecha_comp` timestamp NULL DEFAULT NULL
  ) ENGINE=InnoDB AUTO_INCREMENT=153 DEFAULT CHARSET=utf8;



  PRIMERAS TABLAS:

    VERSION NUEVA
      CREATE TABLE IF NOT EXISTS `alm_historial_s` (
        `ID` bigint(20) NOT NULL AUTO_INCREMENT,
        `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        `nr_solicitud` varchar(10) NOT NULL,
        `fecha_ej` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
        `usuario_ej` varchar(9) NOT NULL,
        `status_ej` enum('carrito','en_proceso','aprobado','enviado', 'retirado', 'completado', 'cancelado', 'anulado', 'cerrado') NOT NULL,
        PRIMARY KEY (`ID`),
        UNIQUE KEY `historial` (`nr_solicitud`, `status_ej`)
      ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1 ;
    VERSION VIEJA
      CREATE TABLE IF NOT EXISTS `alm_historial_s` (
        `ID` bigint(20) NOT NULL,
        `TIME` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        `NRS` varchar(10) NOT NULL,
        `fecha_gen` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
        `fecha_ap` timestamp NULL DEFAULT NULL,
        `fecha_desp` timestamp NULL DEFAULT NULL,
        `fecha_comp` timestamp NULL DEFAULT NULL,
        `usuario_gen` varchar(9) NOT NULL,
        `usuario_ap` varchar(9) DEFAULT NULL
      ) ENGINE=InnoDB AUTO_INCREMENT=153 DEFAULT CHARSET=utf8;
    Trancision:
    alm_historial_s.ID = alm_historial_s.ID
    alm_historial_s.TIME = alm_historial_s.TIME
    alm_historial_s.nr_solicitud = join alm_genera.NRS = alm_historial_s.NRS, select alm_genera.nr_solicitud